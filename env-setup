#!/bin/sh

if [ ! -d ".status" ]; then
	mkdir .status 
fi

./setup/install-dependencies
./setup/install-npm
#./setup/install-pyjs

# Install GnuCOBOL
ldconfig /usr/local/lib

./setup/install-jsil
./setup/install-emscripten
./setup/install-gcc
./setup/install-llvm
./setup/install-dragonegg
./setup/install-ghcjs

if [ ! -f ".status/find-main" ]; then
	git clone https://github.com/duffslaves/main-finder.git
	
	cd main-finder
	mvn package
	cd ../
	
	#echo > .status/find-main
fi

if [ ! -f ".status/chicken" ]; then
	apt-get install -y chicken-bin

	wget 

	7z x chicken.tar.gz
	7z x chicken.tar
	rm chicken.tar.gz
	rm chicken.tar

	mkdir command/chicken-files
	mv chicken/runtime.c        command/chicken-files/runtime.c
	mv chicken/library.c        command/chicken-files/library.c
	mv chicken/eval.c           command/chicken-files/eval.c
	mv chicken/extras.c         command/chicken-files/extras.c
	mv chicken/modules.c        command/chicken-files/modules.c
	mv chicken/build-version.c  command/chicken-files/build-version.c
	mv chicken/chicken.h        command/chicken-files/chicken.h
	mv chicken/chicken-config.h command/chicken-files/chicken-config.h
	mv chicken/buildtag.h       command/chicken-files/buildtag.h

	rm -rf chicken

	chmod 333 command/chicken-files -R
	
	echo > .status/chicken
fi

if [ ! -f ".status/opal" ]; then
	gem install opal
	
	echo > .status/opal
fi

# We don't build cobol yet
#./setup/install-cobol

if [ ! -f '.status/colorama' ]; then
	pip install colorama
	
	echo > .status/colorama
fi

# Add our commands to shell environment
# This will require a restart to take effect
echo export PATH=\$PATH:$PWD/commands:~/.cabal/bin > /etc/profile.d/moodle-code-window.sh
chmod a+x /etc/profile.d/moodle-code-window.sh

